# 图片水印移除组件 PRD

本文档定义在当前 Next.js 模板项目中新增“图片水印移除组件”的产品需求、交互设计、技术方案、验收标准与边界条件，以便在实现前进行评审与对齐。

参考模版组件开发文档：https://docs.shipany.ai/zh/tutorials/new-components

## 1. 目标与价值
- 目标：提供一个开箱即用的图片水印/标记移除组件，支持上传/粘贴图片、以画笔选择区域并一键消除，算法可配置，默认使用 Inpainting（Telea/Navier-Stokes）。
- 价值：在浏览器内完成基础级别的水印/划痕/小块对象去除，减少用户对第三方工具的依赖，适用于内容创作、素材清理、截图标注清除等场景。

## 2. 用户故事
- 作为内容创作者，我希望拖拽或粘贴图片后，快速用画笔涂抹水印区域，然后一键消除。
- 作为运营同学，我希望可以选择不同的消除算法，以在不同素材上获得更好效果。
- 作为普通用户，我希望画笔粗细可调（0–100），并能撤销/重做操作，方便反复微调。
- 作为隐私敏感用户，我希望默认尽可能在本地完成处理，不上传到服务器。

## 3. 范围与不做
- 在做：
  - 单图处理，支持上传文件、拖拽、粘贴（Clipboard）。
  - 以画笔涂抹生成掩膜（mask），掩膜可清除、撤销/重做、调整画笔大小（0–100）。
  - 对掩膜区域进行消除，默认算法 Inpainting（Telea/Navier-Stokes）。
  - 支持算法切换与参数配置（例如半径/迭代等，按算法暴露常用参数）。
  - 导出结果（下载 PNG/JPEG、复制到剪贴板）。
- 不做（首版）：
  - 批量处理与多图队列。
  - 任意复杂的“生成式填充/局部重绘”（可在后续扩展）。
  - 选区形状编辑（例如套索/矩形选择），首版仅画笔自由涂抹。

## 4. 关键需求与交互
- 图片输入：
  - 上传：点击选择或拖拽文件到组件容器。
  - 粘贴：在组件聚焦时，直接粘贴剪贴板图片（支持 PNG/JPEG/WebP）。
  - 基本校验：限制最大分辨率（默认最长边 ≤ 4096px，可配置），超过则提供等比缩放导入提示。

- 画笔与掩膜：
  - 画笔绘制：在画布上按住左键涂抹；支持触摸与 Apple Pencil 等指针设备。
  - 画笔粗细：范围 0–100（默认 24，可配置默认值），通过滑块或快捷键调节（`]` 增大，`[` 减小）。
  - 撤销/重做：每次涂抹作为一步，提供撤销/重做按钮与快捷键（Cmd/Ctrl+Z / Shift+Cmd/Ctrl+Z）。
  - 橡皮擦：开启后改为擦除掩膜（非必须，但建议）。
  - 掩膜可视：以半透明红色叠加（强度可在 UI 中调节）。

- 视图控制：
  - 画布自适应容器大小；支持缩放/平移（滚轮缩放，按住空格拖拽）。
  - 适配移动端触控缩放。

- 消除处理：
  - 操作入口：按钮“消除所选区域”。
  - 处理中的反馈：进度指示（不阻塞主线程，避免 UI 卡顿）。
  - 处理完成：在画布上替换为处理后的图像，并保留上一版本以便撤销。
  - 导出：下载（PNG/JPEG，质量可选）、复制到剪贴板。

- 算法与参数：
  - 默认算法：Inpainting — Telea / Navier-Stokes（OpenCV 原生对应 INPAINT_TELEA / INPAINT_NS）。
  - 算法选择：下拉选择；参数面板根据算法展示常用参数（如 inpaintRadius）。
  - 可扩展算法占位：后续可接入 PatchMatch、Fast Marching、或服务端 Stable Diffusion Inpainting。

- 错误与异常：
  - 不支持格式、图片过大、内存不足、处理失败等，提供用户可读提示与重试入口。

## 5. 组件形态与 API
- 组件名（建议）：`<WatermarkRemover />`
- 目录建议：`components/watermark-remover`（遵循模板组件规范）
- Props（首版）：
  - `defaultAlgorithm?: 'telea' | 'ns'` — 默认算法（Telea/Navier-Stokes）。
  - `algorithms?: Array<'telea' | 'ns'>` — 可用算法集合（用于下拉、参数面板）。
  - `defaultBrushSize?: number` — 画笔初始粗细，默认 24，范围 0–100（在 UI 限制）。
  - `maxDimension?: number` — 导入最长边上限，默认 4096。
  - `initialImage?: string | File | ArrayBuffer` — 初始图片（可选）。
  - `onProcessStart?: (meta) => void` — 开始处理回调。
  - `onProcessEnd?: (result: { blob: Blob; url: string }) => void` — 成功回调。
  - `onError?: (err: Error | { code: string; message: string }) => void` — 错误回调。
  - `processingBackend?: 'wasm' | 'server'` — 处理后端，默认 `'wasm'`（本地 OpenCV.js）。
  - `serverEndpoint?: string` — 当 backend 为 server 时的 API 地址（`POST /api/inpaint`）。
  - `className?: string` — 容器样式透传，适配模板的样式系统。

- 事件与方法（可选扩展）：
  - `exportResult(options)`：导出结果。
  - `reset()`：重置为初始状态。
  - `loadImage(input)`：载入新图（供外部调用）。

## 6. 技术方案
- 前端渲染：
  - 使用 `<canvas>` + 叠加掩膜画布；掩膜以 8bit 单通道灰度贴图维护。
  - 使用 `OffscreenCanvas` + `Web Worker`（可选）在浏览器端执行 Inpainting，避免主线程阻塞。
  - 使用 OpenCV.js（WASM）实现 Telea / Navier-Stokes 算法：`cv.inpaint(src, mask, dst, inpaintRadius, flags)`。
  - 若设备不支持/加载 WASM 失败，降级到服务端 API（可配置）。

- 服务端（可选，扩展能力）：
  - 新增 `POST /api/inpaint`：接收 `image`、`mask`、`algorithm`、`params`，返回处理后图像。
  - Node 环境用 `opencv4nodejs` 或 python 子进程（OpenCV）进行处理。
  - 首版默认不启用服务端处理，保留接口与开关。

- 性能与内存：
  - 导入时对超大图等比缩放至 `maxDimension`，保留缩放比例以便导出时恢复。
  - Web Worker 传输使用 `ImageBitmap` 与 `ImageData`，必要时采用 `transferable` 降低拷贝成本。
  - 控制历史步数（撤销栈），默认最多 20 步，可配置或自动基于内存压力裁剪。

## 7. UI 草图（文字说明）
- 工具栏（上/侧）：
  - 算法选择下拉（Telea / Navier-Stokes），可展开参数。
  - 画笔大小滑块（0–100），显示当前大小。
  - 橡皮擦开关、撤销/重做、清空掩膜、消除按钮。
  - 导入（上传/粘贴提示）、导出（下载/复制）。
- 画布区：
  - 中心自适应显示图片；支持缩放、拖拽；掩膜以半透明红色叠加；右下角显示缩放比例。
- 反馈：
  - 处理时顶部/右上角显示进度与取消按钮；失败时 toast 提示。

## 8. 可用性与无障碍
- 键盘：画笔大小 `[`/`]`，撤销/重做 `Cmd/Ctrl+Z` / `Shift+Cmd/Ctrl+Z`，空格+拖拽平移。
- ARIA：为按钮、滑块、进度等提供语义标签；掩膜强度对色弱用户可手动调节。
- 响应式：移动端工具栏合并为折叠菜单；触控优先手势不与滚动冲突。

## 9. 本地化与文案
- 支持 i18n（中/英），关键文案：上传/粘贴、画笔大小、橡皮擦、撤销/重做、清空、消除、算法、参数、处理中、失败重试、导出等。

## 10. 安全与隐私
- 默认本地处理；启用服务端时在 UI 明示“可能上传图片”，并提供“仅本地处理”开关。
- 粘贴数据仅用于当前会话，不做持久化；服务端请求避免日志记录原图。

## 11. 错误场景与处理
- 图片过大或内存不足：提示并建议缩放导入或降低分辨率。
- WASM 加载失败：提示并建议切换至服务端模式（若已配置）。
- 掩膜为空：点击消除时给出提示“未选择区域”。
- 导出失败：提示并提供重试与下载原图。

## 12. 成功标准（验收标准）
- 能上传/拖拽/粘贴单张图片并正确展示。
- 画笔可涂抹、橡皮擦可擦除、撤销/重做生效，画笔大小 0–100 可调。
- 在默认算法 Telea/NS 下，点击“消除”可得到合理效果，且 UI 无明显卡顿（< 200ms 主线程阻塞）。
- 可导出处理结果为 PNG/JPEG；可复制到剪贴板（受浏览器权限限制时给出可用提示）。
- 算法选择与参数变更生效；切换算法不导致崩溃或内存泄露。

## 13. 指标与观测（可选）
- 交互成功率（成功导入/导出占比）、平均处理时长、WASM 加载成功率、错误率。

## 14. 交付清单
- 组件：`components/watermark-remover/index.tsx`（主组件），`hooks/`（画布/掩膜/撤销）、`workers/`（处理 worker）、`utils/opencv.ts`（OpenCV.js 加载与封装）。
- 可选 API：`app/api/inpaint/route.ts`（或 `pages/api/inpaint.ts`，视项目结构而定）。
- Demo 页面：`app/(examples)/watermark-remover/page.tsx` 便于验收。
- 文档：`README` 片段与属性说明、使用示例。

## 15. 风险与缓解
- OpenCV.js 体积较大：懒加载与分包；首屏不加载，进入组件时再加载。
- 内存/性能瓶颈：限制分辨率、Worker 计算、历史步数上限、自动降级方案。
- 浏览器兼容：针对 iOS Safari 的 OffscreenCanvas 降级；提供主线程计算兜底并展示加载指示。

## 16. 里程碑与时间预估（建议）
- D1：PRD 评审、交互稿细化、技术预研（OpenCV.js 加载/Worker 通道）。
- D2：组件骨架、画布与掩膜绘制、撤销/重做。
- D3：WASM 接入 Telea/NS、参数面板、处理流程与进度反馈。
- D4：导出/复制、错误处理、i18n、移动端适配。
- D5：示例页、文档、回归测试与打磨。

## 17. 开放问题（待确认）
- 是否默认启用服务端备选通道？若启用，后端技术栈与资源限制如何？
- 最大分辨率是否允许用户在设置中自定义？
- 首版是否需要提供“选择框（矩形/套索）”工具？

—— 完 ——

